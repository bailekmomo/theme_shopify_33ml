{% comment %}
  Snippet : Bouton Pack
  Objectif : bouton "Créer mon pack" personnalisable dans le bloc produit
{% endcomment %}

{% assign main_tag = product.tags.first %}
{% assign collection_handle = main_tag | handle %}
{% assign collection = collections[collection_handle] %}
{% assign discount_code = "PACK10" %}
{% assign count = 2 %}

{% if collection and collection.products.size > count %}
  <style>
    .bundle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      border-radius: var(--bundle-radius, 6px);
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease-in-out;
    }
    .bundle-btn img {
      width: 22px;
      height: 22px;
      object-fit: contain;
    }
  </style>

  <button 
    id="bundle-add-btn"
    class="bundle-btn"
    data-count="{{ count }}"
    data-current-variant="{{ product.selected_or_first_available_variant.id }}"
    data-products='[
      {% for p in collection.products %}
        {% unless p.id == product.id %}
          {{ p.selected_or_first_available_variant.id }},
        {% endunless %}
      {% endfor %}
    ]'
    data-discount-code="{{ discount_code }}"
    style="
      background-color: {{ block.settings.button_bg }};
      color: {{ block.settings.button_color }};
      border: 1px solid {{ block.settings.button_border }};
      border-radius: {{ block.settings.button_radius }}px;
    "
  >
    {% if block.settings.button_icon != blank %}
      <img src="{{ block.settings.button_icon | image_url: width: 40 }}" alt="Icône">
    {% endif %}
    <span>{{ block.settings.button_text }}</span>
  </button>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('bundle-add-btn');
    if (!btn) return;

    btn.addEventListener('click', async function() {
      btn.disabled = true;

      const discount = btn.getAttribute('data-discount-code');
      const count = parseInt(btn.getAttribute('data-count'));
      const currentVariant = btn.getAttribute('data-current-variant');
      const allVariants = btn.getAttribute('data-products')
        .replace(/[\[\]\s]/g, '')
        .split(',')
        .filter(id => id);

      const shuffled = allVariants.sort(() => 0.5 - Math.random());
      const selected = shuffled.slice(0, count);
      selected.unshift(currentVariant);

      try {
        for (const id of selected) {
          await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, quantity: 1 })
          });
        }

        window.location.href = '/discount/' + encodeURIComponent(discount) + '?redirect=/cart';
      } catch (err) {
        console.error('Erreur bundle:', err);
        alert("Impossible d’ajouter le pack au panier.");
        btn.disabled = false;
      }
    });
  });
  </script>
{% endif %}
